jQuery.expr[':'].regex = function(elem, index, match) {
    var matchParams = match[3].split(','),
        validLabels = /^(data|css):/,
        attr = {
            method: matchParams[0].match(validLabels) ?
                matchParams[0].split(':')[0] : 'attr',
            property: matchParams.shift().replace(validLabels,'')
        },
        regexFlags = 'ig',
        regex = new RegExp(matchParams.join('').replace(/^\s+|\s+$/g,''), regexFlags);
    return regex.test(jQuery(elem)[attr.method](attr.property));
}

$(function(){
    $('a:regex(href,/users/)').each(function (i) {

        var _this = $(this);

        user_id = _this.prop('pathname').split('/')[2];

        _this.attr('data-usertip_url', '/usertip/view/'+user_id);
        _this.addClass('usertip');
    });

    $('.usertip').qtip({
        content: {
            text: function(event, api) {
                $.ajax({ url: this.attr('data-usertip_url') })
                    .done(function(html) {
                        api.set('content.text', html)
                    })
                    .fail(function(xhr, status, error) {
                        api.set('content.text', status + ': ' + error)
                    })

                return 'Загрузка...';
            }
        },
        show: {
            delay: 700
        },
        hide: {
            event: 'click mouseleave',
            fixed: true,
            delay: 300
        },
        position: {
            viewport: $(window)
        },
    });
});